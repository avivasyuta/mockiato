var et=Object.defineProperty;var tt=(c,h,d)=>h in c?et(c,h,{enumerable:!0,configurable:!0,writable:!0,value:d}):c[h]=d;var b=(c,h,d)=>(tt(c,typeof h!="symbol"?h+"":h,d),d),B=(c,h,d)=>{if(!h.has(c))throw TypeError("Cannot "+d)};var T=(c,h,d)=>(B(c,h,"read from private field"),d?d.call(c):h.get(c)),C=(c,h,d)=>{if(h.has(c))throw TypeError("Cannot add the same private member more than once");h instanceof WeakSet?h.add(c):h.set(c,d)},de=(c,h,d,S)=>(B(c,h,"write to private field"),S?S.call(c,d):h.set(c,d),d);var M=(c,h,d)=>(B(c,h,"access private method"),d);(function(){"use strict";var v,E,A,he;let c=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,s)=>(s&=63,s<36?t+=s.toString(36):s<62?t+=(s-26).toString(36).toUpperCase():s>62?t+="-":t+="_",t),"");var h=new TextEncoder;function d(e){return h.encode(e)}function S(e,t){return new TextDecoder(t).decode(e)}function fe(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}var pe=new Set([101,103,204,205,304]);function ge(e){return pe.has(e)}function X(){if(typeof navigator<"u"&&navigator.product==="ReactNative")return!0;if(typeof process<"u"){const e=process.type;return e==="renderer"||e==="worker"?!1:!!(process.versions&&process.versions.node)}return!1}var ye=/(%?)(%([sdjo]))/g;function me(e,t){switch(t){case"s":return e;case"d":case"i":return Number(e);case"j":return JSON.stringify(e);case"o":{if(typeof e=="string")return e;const s=JSON.stringify(e);return s==="{}"||s==="[]"||/^\[object .+?\]$/.test(s)?e:s}}}function x(e,...t){if(t.length===0)return e;let s=0,r=e.replace(ye,(n,i,o,a)=>{const u=t[s],l=me(u,a);return i?n:(s++,l)});return s<t.length&&(r+=` ${t.slice(s).join(" ")}`),r=r.replace(/%{2,2}/g,"%"),r}var ve=2;function be(e){if(!e.stack)return;const t=e.stack.split(`
`);t.splice(1,ve),e.stack=t.join(`
`)}var xe=class extends Error{constructor(e,...t){super(e),this.message=e,this.name="Invariant Violation",this.message=x(e,...t),be(this)}},q=(e,t,...s)=>{if(!e)throw new xe(t,...s)};q.as=(e,t,s,...r)=>{if(!t)throw e.prototype.name!=null?new e(x(s,r)):e(x(s,r))};var qe=Object.defineProperty,we=(e,t)=>{for(var s in t)qe(e,s,{get:t[s],enumerable:!0})},_={};we(_,{blue:()=>Ee,gray:()=>H,green:()=>Pe,red:()=>Re,yellow:()=>Le});function Le(e){return`\x1B[33m${e}\x1B[0m`}function Ee(e){return`\x1B[34m${e}\x1B[0m`}function H(e){return`\x1B[90m${e}\x1B[0m`}function Re(e){return`\x1B[31m${e}\x1B[0m`}function Pe(e){return`\x1B[32m${e}\x1B[0m`}var I=X(),$=class{constructor(e){b(this,"prefix");this.name=e,this.prefix=`[${this.name}]`;const t=N("DEBUG"),s=N("LOG_LEVEL");t==="1"||t==="true"||typeof t<"u"&&this.name.startsWith(t)?(this.debug=R(s,"debug")?m:this.debug,this.info=R(s,"info")?m:this.info,this.success=R(s,"success")?m:this.success,this.warning=R(s,"warning")?m:this.warning,this.error=R(s,"error")?m:this.error):(this.info=m,this.success=m,this.warning=m,this.error=m,this.only=m)}extend(e){return new $(`${this.name}:${e}`)}debug(e,...t){this.logEntry({level:"debug",message:H(e),positionals:t,prefix:this.prefix,colors:{prefix:"gray"}})}info(e,...t){this.logEntry({level:"info",message:e,positionals:t,prefix:this.prefix,colors:{prefix:"blue"}});const s=new Te;return(r,...n)=>{s.measure(),this.logEntry({level:"info",message:`${r} ${H(`${s.deltaTime}ms`)}`,positionals:n,prefix:this.prefix,colors:{prefix:"blue"}})}}success(e,...t){this.logEntry({level:"info",message:e,positionals:t,prefix:`✔ ${this.prefix}`,colors:{timestamp:"green",prefix:"green"}})}warning(e,...t){this.logEntry({level:"warning",message:e,positionals:t,prefix:`⚠ ${this.prefix}`,colors:{timestamp:"yellow",prefix:"yellow"}})}error(e,...t){this.logEntry({level:"error",message:e,positionals:t,prefix:`✖ ${this.prefix}`,colors:{timestamp:"red",prefix:"red"}})}only(e){e()}createEntry(e,t){return{timestamp:new Date,level:e,message:t}}logEntry(e){const{level:t,message:s,prefix:r,colors:n,positionals:i=[]}=e,o=this.createEntry(t,s),a=(n==null?void 0:n.timestamp)||"gray",u=(n==null?void 0:n.prefix)||"gray",l={timestamp:_[a],prefix:_[u]};this.getWriter(t)([l.timestamp(this.formatTimestamp(o.timestamp))].concat(r!=null?l.prefix(r):[]).concat(G(s)).join(" "),...i.map(G))}formatTimestamp(e){return`${e.toLocaleTimeString("en-GB")}:${e.getMilliseconds()}`}getWriter(e){switch(e){case"debug":case"success":case"info":return Se;case"warning":return Ie;case"error":return Oe}}},Te=class{constructor(){b(this,"startTime");b(this,"endTime");b(this,"deltaTime");this.startTime=performance.now()}measure(){this.endTime=performance.now();const e=this.endTime-this.startTime;this.deltaTime=e.toFixed(2)}},m=()=>{};function Se(e,...t){if(I){process.stdout.write(x(e,...t)+`
`);return}console.log(e,...t)}function Ie(e,...t){if(I){process.stderr.write(x(e,...t)+`
`);return}console.warn(e,...t)}function Oe(e,...t){if(I){process.stderr.write(x(e,...t)+`
`);return}console.error(e,...t)}function N(e){var t;return I?process.env[e]:(t=globalThis[e])==null?void 0:t.toString()}function R(e,t){return e!==void 0&&e!==t}function G(e){return typeof e>"u"?"undefined":e===null?"null":typeof e=="string"?e:typeof e=="object"?JSON.stringify(e):e.toString()}var Me=class extends Error{constructor(e,t,s){super(`Possible EventEmitter memory leak detected. ${s} ${t.toString()} listeners added. Use emitter.setMaxListeners() to increase limit`),this.emitter=e,this.type=t,this.count=s,this.name="MaxListenersExceededWarning"}},W=class{static listenerCount(e,t){return e.listenerCount(t)}constructor(){this.events=new Map,this.maxListeners=W.defaultMaxListeners,this.hasWarnedAboutPotentialMemoryLeak=!1}_emitInternalEvent(e,t,s){this.emit(e,t,s)}_getListeners(e){return Array.prototype.concat.apply([],this.events.get(e))||[]}_removeListener(e,t){const s=e.indexOf(t);return s>-1&&e.splice(s,1),[]}_wrapOnceListener(e,t){const s=(...r)=>(this.removeListener(e,s),t.apply(this,r));return Object.defineProperty(s,"name",{value:t.name}),s}setMaxListeners(e){return this.maxListeners=e,this}getMaxListeners(){return this.maxListeners}eventNames(){return Array.from(this.events.keys())}emit(e,...t){const s=this._getListeners(e);return s.forEach(r=>{r.apply(this,t)}),s.length>0}addListener(e,t){this._emitInternalEvent("newListener",e,t);const s=this._getListeners(e).concat(t);if(this.events.set(e,s),this.maxListeners>0&&this.listenerCount(e)>this.maxListeners&&!this.hasWarnedAboutPotentialMemoryLeak){this.hasWarnedAboutPotentialMemoryLeak=!0;const r=new Me(this,e,this.listenerCount(e));console.warn(r)}return this}on(e,t){return this.addListener(e,t)}once(e,t){return this.addListener(e,this._wrapOnceListener(e,t))}prependListener(e,t){const s=this._getListeners(e);if(s.length>0){const r=[t].concat(s);this.events.set(e,r)}else this.events.set(e,s.concat(t));return this}prependOnceListener(e,t){return this.prependListener(e,this._wrapOnceListener(e,t))}removeListener(e,t){const s=this._getListeners(e);return s.length>0&&(this._removeListener(s,t),this.events.set(e,s),this._emitInternalEvent("removeListener",e,t)),this}off(e,t){return this.removeListener(e,t)}removeAllListeners(e){return e?this.events.delete(e):this.events.clear(),this}listeners(e){return Array.from(this._getListeners(e))}listenerCount(e){return this._getListeners(e).length}rawListeners(e){return this.listeners(e)}},F=W;F.defaultMaxListeners=10;var w=Symbol("isPatchedModule");function U(e){return globalThis[e]||void 0}function Ae(e,t){globalThis[e]=t}function _e(e){delete globalThis[e]}var k=class{constructor(e){this.symbol=e,this.readyState="INACTIVE",this.emitter=new F,this.subscriptions=[],this.logger=new $(e.description),this.emitter.setMaxListeners(0),this.logger.info("constructing the interceptor...")}checkEnvironment(){return!0}apply(){const e=this.logger.extend("apply");if(e.info("applying the interceptor..."),this.readyState==="APPLIED"){e.info("intercepted already applied!");return}if(!this.checkEnvironment()){e.info("the interceptor cannot be applied in this environment!");return}this.readyState="APPLYING";const s=this.getInstance();if(s){e.info("found a running instance, reusing..."),this.on=(r,n)=>(e.info('proxying the "%s" listener',r),s.emitter.addListener(r,n),this.subscriptions.push(()=>{s.emitter.removeListener(r,n),e.info('removed proxied "%s" listener!',r)}),this),this.readyState="APPLIED";return}e.info("no running instance found, setting up a new instance..."),this.setup(),this.setInstance(),this.readyState="APPLIED"}setup(){}on(e,t){const s=this.logger.extend("on");return this.readyState==="DISPOSING"||this.readyState==="DISPOSED"?(s.info("cannot listen to events, already disposed!"),this):(s.info('adding "%s" event listener:',e,t),this.emitter.on(e,t),this)}once(e,t){return this.emitter.once(e,t),this}off(e,t){return this.emitter.off(e,t),this}removeAllListeners(e){return this.emitter.removeAllListeners(e),this}dispose(){const e=this.logger.extend("dispose");if(this.readyState==="DISPOSED"){e.info("cannot dispose, already disposed!");return}if(e.info("disposing the interceptor..."),this.readyState="DISPOSING",!this.getInstance()){e.info("no interceptors running, skipping dispose...");return}if(this.clearInstance(),e.info("global symbol deleted:",U(this.symbol)),this.subscriptions.length>0){e.info("disposing of %d subscriptions...",this.subscriptions.length);for(const t of this.subscriptions)t();this.subscriptions=[],e.info("disposed of all subscriptions!",this.subscriptions.length)}this.emitter.removeAllListeners(),e.info("destroyed the listener!"),this.readyState="DISPOSED"}getInstance(){var e;const t=U(this.symbol);return this.logger.info("retrieved global instance:",(e=t==null?void 0:t.constructor)==null?void 0:e.name),t}setInstance(){Ae(this.symbol,this),this.logger.info("set global instance!",this.symbol.description)}clearInstance(){_e(this.symbol),this.logger.info("cleared global instance!",this.symbol.description)}},D=class extends k{constructor(e){D.symbol=Symbol(e.name),super(D.symbol),this.interceptors=e.interceptors}setup(){const e=this.logger.extend("setup");e.info("applying all %d interceptors...",this.interceptors.length);for(const t of this.interceptors)e.info('applying "%s" interceptor...',t.constructor.name),t.apply(),e.info("adding interceptor dispose subscription"),this.subscriptions.push(()=>t.dispose())}on(e,t){for(const s of this.interceptors)s.on(e,t);return this}once(e,t){for(const s of this.interceptors)s.once(e,t);return this}off(e,t){for(const s of this.interceptors)s.off(e,t);return this}removeAllListeners(e){for(const t of this.interceptors)t.removeAllListeners(e);return this}};function He(){const e=(t,s)=>{e.state="pending",e.resolve=r=>{if(e.state!=="pending")return;e.result=r;const n=i=>(e.state="fulfilled",i);return t(r instanceof Promise?r:Promise.resolve(r).then(n))},e.reject=r=>{if(e.state==="pending")return queueMicrotask(()=>{e.state="rejected"}),s(e.rejectionReason=r)}};return e}var V=(he=class extends Promise{constructor(t=null){const s=He();super((r,n)=>{s(r,n),t==null||t(s.resolve,s.reject)});C(this,E);C(this,v,void 0);b(this,"resolve");b(this,"reject");de(this,v,s),this.resolve=T(this,v).resolve,this.reject=T(this,v).reject}get state(){return T(this,v).state}get rejectionReason(){return T(this,v).rejectionReason}then(t,s){return M(this,E,A).call(this,super.then(t,s))}catch(t){return M(this,E,A).call(this,super.catch(t))}finally(t){return M(this,E,A).call(this,super.finally(t))}},v=new WeakMap,E=new WeakSet,A=function(t){return Object.defineProperties(t,{resolve:{configurable:!0,value:this.resolve},reject:{configurable:!0,value:this.reject}})},he);function J(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e=="x"?t:t&3|8).toString(16)})}var ke=class{constructor(e){this.request=e,this.responsePromise=new V}respondWith(e){q(this.responsePromise.state==="pending",'Failed to respond to "%s %s" request: the "request" event has already been responded to.',this.request.method,this.request.url),this.responsePromise.resolve(e)}};function z(e){const t=new ke(e);return Reflect.set(e,"respondWith",t.respondWith.bind(t)),{interactiveRequest:e,requestController:t}}async function Y(e,t,...s){const r=e.listeners(t);if(r.length!==0)for(const n of r)await n.apply(e,s)}var K=async e=>{try{return{error:null,data:await e().catch(s=>{throw s})}}catch(t){return{error:t,data:null}}};function De(e,t){try{return e[t],!0}catch{return!1}}var Q=class extends k{constructor(){super(Q.symbol)}checkEnvironment(){return typeof globalThis<"u"&&typeof globalThis.fetch<"u"}setup(){const e=globalThis.fetch;q(!e[w],'Failed to patch the "fetch" module: already patched.'),globalThis.fetch=async(t,s)=>{var r;const n=J(),i=new Request(t,s);this.logger.info("[%s] %s",i.method,i.url);const{interactiveRequest:o,requestController:a}=z(i);this.logger.info('emitting the "request" event for %d listener(s)...',this.emitter.listenerCount("request")),this.emitter.once("request",({requestId:p})=>{p===n&&a.responsePromise.state==="pending"&&a.responsePromise.resolve(void 0)}),this.logger.info("awaiting for the mocked response...");const u=o.signal,l=new V;u.addEventListener("abort",()=>{l.reject(u.reason)},{once:!0});const g=await K(async()=>{const p=Y(this.emitter,"request",{request:o,requestId:n});await Promise.race([l,p,a.responsePromise]),this.logger.info("all request listeners have been resolved!");const y=await a.responsePromise;return this.logger.info("event.respondWith called with:",y),y});if(l.state==="rejected")return Promise.reject(l.rejectionReason);if(g.error)return Promise.reject(ee(g.error));const f=g.data;if(f&&!((r=i.signal)!=null&&r.aborted)){if(this.logger.info("received mocked response:",f),De(f,"type")&&f.type==="error")return this.logger.info("received a network error response, rejecting the request promise..."),Promise.reject(ee(f));const p=f.clone();this.emitter.emit("response",{response:p,isMockedResponse:!0,request:o,requestId:n});const y=new Response(f.body,f);return Object.defineProperty(y,"url",{writable:!1,enumerable:!0,configurable:!1,value:i.url}),y}return this.logger.info("no mocked response received!"),e(i).then(p=>{const y=p.clone();return this.logger.info("original fetch performed",y),this.emitter.emit("response",{response:y,isMockedResponse:!1,request:o,requestId:n}),p})},Object.defineProperty(globalThis.fetch,w,{enumerable:!0,configurable:!0,value:!0}),this.subscriptions.push(()=>{Object.defineProperty(globalThis.fetch,w,{value:void 0}),globalThis.fetch=e,this.logger.info('restored native "globalThis.fetch"!',globalThis.fetch.name)})}},Z=Q;Z.symbol=Symbol("fetch");function ee(e){return Object.assign(new TypeError("Failed to fetch"),{cause:e})}function je(e,t){const s=new Uint8Array(e.byteLength+t.byteLength);return s.set(e,0),s.set(t,e.byteLength),s}var te=class{constructor(e,t){this.AT_TARGET=0,this.BUBBLING_PHASE=0,this.CAPTURING_PHASE=0,this.NONE=0,this.type="",this.srcElement=null,this.currentTarget=null,this.eventPhase=0,this.isTrusted=!0,this.composed=!1,this.cancelable=!0,this.defaultPrevented=!1,this.bubbles=!0,this.lengthComputable=!0,this.loaded=0,this.total=0,this.cancelBubble=!1,this.returnValue=!0,this.type=e,this.target=(t==null?void 0:t.target)||null,this.currentTarget=(t==null?void 0:t.currentTarget)||null,this.timeStamp=Date.now()}composedPath(){return[]}initEvent(e,t,s){this.type=e,this.bubbles=!!t,this.cancelable=!!s}preventDefault(){this.defaultPrevented=!0}stopPropagation(){}stopImmediatePropagation(){}},Be=class extends te{constructor(e,t){super(e),this.lengthComputable=(t==null?void 0:t.lengthComputable)||!1,this.composed=(t==null?void 0:t.composed)||!1,this.loaded=(t==null?void 0:t.loaded)||0,this.total=(t==null?void 0:t.total)||0}},Ce=typeof ProgressEvent<"u";function Xe(e,t,s){const r=["error","progress","loadstart","loadend","load","timeout","abort"],n=Ce?ProgressEvent:Be;return r.includes(t)?new n(t,{lengthComputable:!0,loaded:(s==null?void 0:s.loaded)||0,total:(s==null?void 0:s.total)||0}):new te(t,{target:e,currentTarget:e})}function se(e,t){if(!(t in e))return null;if(Object.prototype.hasOwnProperty.call(e,t))return e;const r=Reflect.getPrototypeOf(e);return r?se(r,t):null}function re(e,t){return new Proxy(e,$e(t))}function $e(e){const{constructorCall:t,methodCall:s,getProperty:r,setProperty:n}=e,i={};return typeof t<"u"&&(i.construct=function(o,a,u){const l=Reflect.construct.bind(null,o,a,u);return t.call(u,a,l)}),i.set=function(o,a,u){const l=()=>{const g=se(o,a)||o,f=Reflect.getOwnPropertyDescriptor(g,a);return typeof(f==null?void 0:f.set)<"u"?(f.set.apply(o,[u]),!0):Reflect.defineProperty(g,a,{writable:!0,enumerable:!0,configurable:!0,value:u})};return typeof n<"u"?n.call(o,[a,u],l):l()},i.get=function(o,a,u){const l=()=>o[a],g=typeof r<"u"?r.call(o,[a,u],l):l();return typeof g=="function"?(...f)=>{const p=g.bind(o,...f);return typeof s<"u"?s.call(o,[a,f],p):p()}:g},i}function Ne(e){return["application/xhtml+xml","application/xml","image/svg+xml","text/html","text/xml"].some(s=>e.startsWith(s))}function Ge(e){try{return JSON.parse(e)}catch{return null}}function We(e,t){const s=ge(e.status)?null:t;return new Response(s,{status:e.status,statusText:e.statusText,headers:Fe(e.getAllResponseHeaders())})}function Fe(e){const t=new Headers,s=e.split(/[\r\n]+/);for(const r of s){if(r.trim()==="")continue;const[n,...i]=r.split(": "),o=i.join(": ");t.append(n,o)}return t}var ne=Symbol("isMockedResponse"),Ue=X(),Ve=class{constructor(e,t){this.initialRequest=e,this.logger=t,this.method="GET",this.url=null,this.events=new Map,this.requestId=J(),this.requestHeaders=new Headers,this.responseBuffer=new Uint8Array,this.request=re(e,{setProperty:([s,r],n)=>{switch(s){case"ontimeout":{const i=s.slice(2);return this.request.addEventListener(i,r),n()}default:return n()}},methodCall:([s,r],n)=>{var i;switch(s){case"open":{const[o,a]=r;return typeof a>"u"?(this.method="GET",this.url=oe(o)):(this.method=o,this.url=oe(a)),this.logger=this.logger.extend(`${this.method} ${this.url.href}`),this.logger.info("open",this.method,this.url.href),n()}case"addEventListener":{const[o,a]=r;return this.registerEvent(o,a),this.logger.info("addEventListener",o,a),n()}case"setRequestHeader":{const[o,a]=r;return this.requestHeaders.set(o,a),this.logger.info("setRequestHeader",o,a),n()}case"send":{const[o]=r;o!=null&&(this.requestBody=typeof o=="string"?d(o):o),this.request.addEventListener("load",()=>{if(typeof this.onResponse<"u"){const l=We(this.request,this.request.response);this.onResponse.call(this,{response:l,isMockedResponse:ne in this.request,request:a,requestId:this.requestId})}});const a=this.toFetchApiRequest();(((i=this.onRequest)==null?void 0:i.call(this,{request:a,requestId:this.requestId}))||Promise.resolve()).finally(()=>{if(this.request.readyState<this.request.LOADING)return this.logger.info("request callback settled but request has not been handled (readystate %d), performing as-is...",this.request.readyState),Ue&&this.request.setRequestHeader("X-Request-Id",this.requestId),n()});break}default:return n()}}})}registerEvent(e,t){const r=(this.events.get(e)||[]).concat(t);this.events.set(e,r),this.logger.info('registered event "%s"',e,t)}respondWith(e){this.logger.info("responding with a mocked response: %d %s",e.status,e.statusText),L(this.request,ne,!0),L(this.request,"status",e.status),L(this.request,"statusText",e.statusText),L(this.request,"responseURL",this.url.href),this.request.getResponseHeader=new Proxy(this.request.getResponseHeader,{apply:(r,n,i)=>{if(this.logger.info("getResponseHeader",i[0]),this.request.readyState<this.request.HEADERS_RECEIVED)return this.logger.info("headers not received yet, returning null"),null;const o=e.headers.get(i[0]);return this.logger.info('resolved response header "%s" to',i[0],o),o}}),this.request.getAllResponseHeaders=new Proxy(this.request.getAllResponseHeaders,{apply:()=>{if(this.logger.info("getAllResponseHeaders"),this.request.readyState<this.request.HEADERS_RECEIVED)return this.logger.info("headers not received yet, returning empty string"),"";const n=Array.from(e.headers.entries()).map(([i,o])=>`${i}: ${o}`).join(`\r
`);return this.logger.info("resolved all response headers to",n),n}}),Object.defineProperties(this.request,{response:{enumerable:!0,configurable:!1,get:()=>this.response},responseText:{enumerable:!0,configurable:!1,get:()=>this.responseText},responseXML:{enumerable:!0,configurable:!1,get:()=>this.responseXML}});const t=e.headers.has("Content-Length")?Number(e.headers.get("Content-Length")):void 0;this.logger.info("calculated response body length",t),this.trigger("loadstart",{loaded:0,total:t}),this.setReadyState(this.request.HEADERS_RECEIVED),this.setReadyState(this.request.LOADING);const s=()=>{this.logger.info("finalizing the mocked response..."),this.setReadyState(this.request.DONE),this.trigger("load",{loaded:this.responseBuffer.byteLength,total:t}),this.trigger("loadend",{loaded:this.responseBuffer.byteLength,total:t})};if(e.body){this.logger.info("mocked response has body, streaming...");const r=e.body.getReader(),n=async()=>{const{value:i,done:o}=await r.read();if(o){this.logger.info("response body stream done!"),s();return}i&&(this.logger.info("read response body chunk:",i),this.responseBuffer=je(this.responseBuffer,i),this.trigger("progress",{loaded:this.responseBuffer.byteLength,total:t})),n()};n()}else s()}responseBufferToText(){return S(this.responseBuffer)}get response(){if(this.logger.info("getResponse (responseType: %s)",this.request.responseType),this.request.readyState!==this.request.DONE)return null;switch(this.request.responseType){case"json":{const e=Ge(this.responseBufferToText());return this.logger.info("resolved response JSON",e),e}case"arraybuffer":{const e=fe(this.responseBuffer);return this.logger.info("resolved response ArrayBuffer",e),e}case"blob":{const e=this.request.getResponseHeader("Content-Type")||"text/plain",t=new Blob([this.responseBufferToText()],{type:e});return this.logger.info("resolved response Blob (mime type: %s)",t,e),t}default:{const e=this.responseBufferToText();return this.logger.info('resolving "%s" response type as text',this.request.responseType,e),e}}}get responseText(){if(q(this.request.responseType===""||this.request.responseType==="text","InvalidStateError: The object is in invalid state."),this.request.readyState!==this.request.LOADING&&this.request.readyState!==this.request.DONE)return"";const e=this.responseBufferToText();return this.logger.info('getResponseText: "%s"',e),e}get responseXML(){if(q(this.request.responseType===""||this.request.responseType==="document","InvalidStateError: The object is in invalid state."),this.request.readyState!==this.request.DONE)return null;const e=this.request.getResponseHeader("Content-Type")||"";return typeof DOMParser>"u"?(console.warn("Cannot retrieve XMLHttpRequest response body as XML: DOMParser is not defined. You are likely using an environment that is not browser or does not polyfill browser globals correctly."),null):Ne(e)?new DOMParser().parseFromString(this.responseBufferToText(),e):null}errorWith(e){this.logger.info("responding with an error"),this.setReadyState(this.request.DONE),this.trigger("error"),this.trigger("loadend")}setReadyState(e){if(this.logger.info("setReadyState: %d -> %d",this.request.readyState,e),this.request.readyState===e){this.logger.info("ready state identical, skipping transition...");return}L(this.request,"readyState",e),this.logger.info("set readyState to: %d",e),e!==this.request.UNSENT&&(this.logger.info('triggerring "readystatechange" event...'),this.trigger("readystatechange"))}trigger(e,t){const s=this.request[`on${e}`],r=Xe(this.request,e,t);this.logger.info('trigger "%s"',e,t||""),typeof s=="function"&&(this.logger.info('found a direct "%s" callback, calling...',e),s.call(this.request,r));for(const[n,i]of this.events)n===e&&(this.logger.info('found %d listener(s) for "%s" event, calling...',i.length,e),i.forEach(o=>o.call(this.request,r)))}toFetchApiRequest(){this.logger.info("converting request to a Fetch API Request...");const e=new Request(this.url.href,{method:this.method,headers:this.requestHeaders,credentials:this.request.withCredentials?"include":"same-origin",body:["GET","HEAD"].includes(this.method)?null:this.requestBody}),t=re(e.headers,{methodCall:([s,r],n)=>{switch(s){case"append":case"set":{const[i,o]=r;this.request.setRequestHeader(i,o);break}case"delete":{const[i]=r;console.warn(`XMLHttpRequest: Cannot remove a "${i}" header from the Fetch API representation of the "${e.method} ${e.url}" request. XMLHttpRequest headers cannot be removed.`);break}}return n()}});return L(e,"headers",t),this.logger.info("converted request to a Fetch API Request!",e),e}};function oe(e){return typeof location>"u"?new URL(e):new URL(e.toString(),location.href)}function L(e,t,s){Reflect.defineProperty(e,t,{writable:!0,enumerable:!0,value:s})}function Je({emitter:e,logger:t}){return new Proxy(globalThis.XMLHttpRequest,{construct(r,n,i){t.info("constructed new XMLHttpRequest");const o=Reflect.construct(r,n,i),a=Object.getOwnPropertyDescriptors(r.prototype);for(const l in a)Reflect.defineProperty(o,l,a[l]);const u=new Ve(o,t);return u.onRequest=async function({request:l,requestId:g}){const{interactiveRequest:f,requestController:p}=z(l);this.logger.info("awaiting mocked response..."),e.once("request",({requestId:O})=>{O===g&&p.responsePromise.state==="pending"&&p.respondWith(void 0)});const y=await K(async()=>{this.logger.info('emitting the "request" event for %s listener(s)...',e.listenerCount("request")),await Y(e,"request",{request:f,requestId:g}),this.logger.info('all "request" listeners settled!');const O=await p.responsePromise;return this.logger.info("event.respondWith called with:",O),O});if(y.error){this.logger.info("request listener threw an exception, aborting request...",y.error),u.errorWith(y.error);return}const P=y.data;if(typeof P<"u"){if(this.logger.info("received mocked response: %d %s",P.status,P.statusText),P.type==="error"){this.logger.info("received a network error response, rejecting the request promise..."),u.errorWith(new TypeError("Network error"));return}return u.respondWith(P)}this.logger.info("no mocked response received, performing request as-is...")},u.onResponse=async function({response:l,isMockedResponse:g,request:f,requestId:p}){this.logger.info('emitting the "response" event for %s listener(s)...',e.listenerCount("response")),e.emit("response",{response:l,isMockedResponse:g,request:f,requestId:p})},u.request}})}var ie=class extends k{constructor(){super(ie.interceptorSymbol)}checkEnvironment(){return typeof globalThis.XMLHttpRequest<"u"}setup(){const e=this.logger.extend("setup");e.info('patching "XMLHttpRequest" module...');const t=globalThis.XMLHttpRequest;q(!t[w],'Failed to patch the "XMLHttpRequest" module: already patched.'),globalThis.XMLHttpRequest=Je({emitter:this.emitter,logger:this.logger}),e.info('native "XMLHttpRequest" module patched!',globalThis.XMLHttpRequest.name),Object.defineProperty(globalThis.XMLHttpRequest,w,{enumerable:!0,configurable:!0,value:!0}),this.subscriptions.push(()=>{Object.defineProperty(globalThis.XMLHttpRequest,w,{value:void 0}),globalThis.XMLHttpRequest=t,e.info('native "XMLHttpRequest" module restored!',globalThis.XMLHttpRequest.name)})}},ae=ie;ae.interceptorSymbol=Symbol("xhr");const le="Mockiato",ue=(e,t)=>{window.postMessage({message:t,type:e,extensionName:le},"*")},ze=(e,t)=>{window.addEventListener("message",s=>{const{data:r,source:n}=s;n!==window||typeof r!="object"||r.type!==e||r.extensionName!==le||t(r.message)})};class Ye{constructor(){b(this,"collector");this.collector={}}addListener(t,s){this.collector[t]=s}dispatch(t,s){const r=this.collector[t];r&&r(s)}}const Ke=e=>{console.error("An error has occurred in the Mockiato extension. Please report it in issues on github https://github.com/avivasyuta/mockiato/issues"),console.error(e)},Qe=e=>new Promise(t=>{setTimeout(t,e)}),ce=new Ye,j=new D({name:"mockiatoInterceptor",interceptors:[new Z,new ae]});j.apply();const Ze=(e,t)=>{const s=c();return ue("requestIntercepted",{messageId:s,url:e,method:t}),new Promise(n=>{ce.addListener(s,n)})};j.on("request",async({request:e})=>{try{const{mock:t,headers:s}=await Ze(e.url,e.method);if(Object.entries(s).forEach(([i,o])=>{e.headers.set(i,o)}),!t)return;const r=t.responseHeaders.reduce((i,o)=>({...i,[o.key]:o.value}),{}),n=new Response(t.response,{status:t.httpStatusCode,headers:r});t.delay&&await Qe(t.delay),e.respondWith(n)}catch(t){Ke(t)}}),j.on("response",async({request:e,response:t})=>{const s=[],r=t.clone();for(const[a,u]of r.headers.entries())s.push({id:c(),key:a,value:u});const n=await r.text();let i;try{JSON.parse(n),i="json"}catch{i="text"}const o={event:{date:new Date().toISOString(),host:window.location.hostname,request:{url:e.url,method:e.method},response:{body:n,type:i,headers:s,httpStatusCode:t.status}}};ue("responseIntercepted",o)}),ze("requestChecked",e=>{ce.dispatch(e.messageId,e)})})();
